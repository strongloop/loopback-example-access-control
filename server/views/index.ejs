<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>LoopBack example access control</title>
  </head>
  <body>
    <h1>Startkicker</h1>
    <table border=1 cellpadding=5>
      <tr>
        <th>Login</th>
        <th>User name</th>
        <th>User type</th>
        <th>Role ($ = built-in role)</th>
      </tr>
      <tr>
        <td><a href="/projects">Guest</a></td>
        <td></td>
        <td>Guest</td>
        <td>$unauthenticated, $everyone</td>
      </tr>
      <tr>
        <td>
          <form action="/projects" method="post">
            <input type="text" name="email" value="john@doe.com" placeholder="Email"><br>
            <input type="password" name="password" value="opensesame" placeholder="Password"><br>
            <input type="submit" value="Request Code"><br>
            <input type="text" name="twofactor" placeholder="Verification Code">
            <input type="hidden" name="timestamp">
          </form>
        </td>
        <td>John</td>
        <td>Owner (of project 1)</td>
        <td>$owner, teamMember, $authenticated, $everyone</td>
      </tr>
      <tr>
        <td>
          <form action="/projects" method="post">
            <input type="text" name="email" value="jane@doe.com" placeholder="Email"><br>
            <input type="password" name="password" value="opensesame" placeholder="Password"><br>
            <input type="submit" value="Request Code"><br>
            <input type="text" name="twofactor" placeholder="Verification Code">
            <input type="hidden" name="timestamp">
          </form>
        </td>
        <td>Jane</td>
        <td>Team member (of project 1)</td>
        <td>teamMember, $authenticated, $everyone</td>
      </tr>
      <tr>
        <td>
          <form action="/projects" method="post">
            <input type="text" name="email" value="bob@projects.com" placeholder="Email"><br>
            <input type="password" name="password" value="opensesame" placeholder="Password"><br>
            <input type="submit" value="Request Code"><br>
            <input type="text" name="twofactor" placeholder="Verification Code">
            <input type="hidden" name="timestamp">
          </form>
        </td>
        <td>Bob</td>
        <td>Administrator</td>
        <td>admin, $authenticated, $everyone</td>
      </tr>
      <% if (loginFailed) { %>
        <tr>
          <td colspan=6>
              <span style="color:red">Login failed, please try again</span>
          </td>
        </tr>
      <% } %>
    </table>
    
    <script>
    (function() {
        var forms = [].__proto__.slice.call(document.querySelectorAll('form'), 0);
        
        forms.forEach(function(f) {
            f.addEventListener('submit', checkForTwoFactorAuth);
        });
        
        function checkForTwoFactorAuth(e) {
            var twofactor = e.target.querySelector("[name=twofactor]"),
                timestamp = e.target.querySelector("[name=timestamp]"),
                button = e.target.querySelector("[type=submit]"),
                email = e.target.querySelector("[name=email]").value,
                password = e.target.querySelector("[name=password]");
            
            if (!twofactor.value) {
                
                sendTwoFactorAuth({ email: email, password: password.value }, function(err, ts) {
                    if (err) return alert(err);
                    
                    var code = prompt('Check your mobile phone for a one-time use code!');
                    if (code) {
                        twofactor.value = code;
                        timestamp.value = ts;
                        button.value = "Login Now!";
                        password.value = "";
                    }
                });
                
                e.preventDefault();
                return false;
            }
        }
        
        function sendTwoFactorAuth(credentials, callback) {
            var xhr = new XMLHttpRequest();
            
            xhr.open("POST", "/api/users/requestCode", true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState !== 4) return;
                
                if (xhr.status !== 200) {
                    return callback('Login failed, please try again');
                }
                
                var ts = JSON.parse(xhr.responseText).timestamp;
                callback(null, ts);
            };
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({
                email: credentials.email,
                password: credentials.password
            }));
        }
    })();
    </script>
    
  </body>
</html>
